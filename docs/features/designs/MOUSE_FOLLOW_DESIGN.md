# マウス追従機能設計書

**Issue #60: マウス追従による頭部・首の自然な動き**

**設計フェーズ**: Phase 6.0 → 実装完了  
**作成日**: 2025年6月3日  
**更新日**: 2025年6月5日  
**実装状況**: ✅ 基本機能実装完了

---

## 📋 目次

1. [概要と要件](#概要と要件)
2. [実装アーキテクチャ](#実装アーキテクチャ)
3. [実装詳細](#実装詳細)
4. [動作仕様](#動作仕様)
5. [将来の拡張計画](#将来の拡張計画)

---

## 概要と要件

### 🎯 機能概要

デスクトップマスコットがユーザーのマウスカーソル位置を自然に追跡し、頭部・首のVRMボーンを使用してリアルタイムで視線を向ける機能。

### 📝 受け入れ基準と実装状況

#### 必須要件 (MUST)
- ✅ **グローバルマウス位置取得**: Electron の `screen.getCursorScreenPoint()` を使用
- ✅ **3D座標変換**: 正規化座標系を経由した変換実装
- ✅ **VRM頭部制御**: 頭部・首ボーンの直接制御（lookAt APIではなく）
- ✅ **アイドル状態制限**: MascotStateManagerによる統合的な状態管理
- ✅ **スムージング**: Quaternion.slerpによる自然な補間

#### 推奨要件 (SHOULD)
- ❌ **ユーザー設定**: UI未実装（機能は常時ON）
- ✅ **パフォーマンス**: 20FPS（50ms間隔）で安定動作

#### 対応環境
- ✅ **Windows/macOS**: 完全サポート（権限不要）
- ❓ **Linux**: 未検証

---

## 実装アーキテクチャ

### 🏗️ シンプルな統合設計

```
┌─────────────────────────────────────────────────────────┐
│         VRMSetupManager（既存サービスを拡張）             │
│  - startGlobalMouseTracking() : マウス追従開始           │
│  - calculateHeadNeckRotation() : 頭部・首回転計算        │
│  - 頭部30%、首70%の回転分配                             │
└────────────────────┬────────────────────────────────────┘
                     │
┌─────────────────────────────────────────────────────────┐
│         MascotStateManager（新規実装）                   │
│  - 表情・アニメーション・スピーチバブルの状態管理           │
│  - isIdleForMouseFollow() : マウス追従可否判定           │
└────────────────────┬────────────────────────────────────┘
                     │
┌─────────────────────────────────────────────────────────┐
│         VRMController（既存・修正）                      │
│  - アイドルアニメーション判定の追加                       │
│  - "Clip"名のアニメーションを特別扱い                    │
└─────────────────────────────────────────────────────────┘
```

---

## 実装詳細

### 🔧 主要実装ファイル

1. **src/services/vrmSetupManager.ts**
   - `startGlobalMouseTracking()`: 50ms間隔でマウス位置を取得
   - `calculateHeadNeckRotation()`: ボーン回転計算（Y軸方向修正済み）
   - 回転制限: Yaw ±60度、Pitch ±45度

2. **src/services/MascotStateManager.ts**
   - シングルトンパターンで実装
   - 表情・アニメーション・スピーチバブルの状態を一元管理
   - アイドル判定ロジック

3. **src/vrmController.ts**
   - アイドルアニメーション判定を追加
   - ハードコーディング警告をコメントで記載

---

## 動作仕様

### 🎮 マウス追従の動作条件

1. **アイドル状態の判定**
   - 表情が「neutral」または未設定
   - アニメーションが未実行またはアイドルアニメーション
   - スピーチバブルが非表示

2. **アイドルアニメーションの扱い**
   - 現在は以下の名前をハードコーディングで判定：
     - `'idle'` を含む名前
     - `'Clip'`（idle.vrmaのデフォルト名）
     - `'Take 001'`、`'mixamo.com'` など

3. **回転動作**
   - 首が70%、頭が30%の回転を分担
   - スムージング係数: 0.1（10%ずつ目標に近づく）

---

## 将来の拡張計画

### 🔮 待機用アニメーション設定機能

**概要**: 現在ハードコーディングされている待機用アニメーションの判定を、ユーザーが設定画面から指定できるようにする。

**実装方針**:

1. **設定画面の拡張**
   - アニメーション設定タブに「待機用アニメーション」セクション追加
   - VRMAファイルの選択UI
   - 複数の待機アニメーション登録

2. **設定データ構造**
   ```typescript
   interface IdleAnimationSettings {
     enabled: boolean;
     animations: Array<{
       id: string;
       path: string;        // VRMAファイルパス
       displayName: string; // 表示名
       tags: string[];      // ['idle', 'wait']
     }>;
   }
   ```

3. **判定ロジックの改善**
   - ハードコーディング削除
   - 設定ベースの判定システム
   - アニメーションメタデータの活用

### 🎛️ マウス追従設定UI

**未実装の設定項目**:
- 機能のON/OFF切り替え
- 感度調整（1.0 = 100%）
- スムージング強度（0.1 = 現在値）
- 追従頻度（20Hz = 現在値）

---

## 📚 参考資料

- [Electron screen API](https://www.electronjs.org/docs/api/screen#screengetcursorscreenpoint)
- [@pixiv/three-vrm](https://github.com/pixiv/three-vrm)
- [CLAUDE.md](../CLAUDE.md) - プロジェクトガイドライン

---

**設計書バージョン**: 2.0（実装反映版）  
**承認者**: 開発チーム  
**次回レビュー**: 設定UI実装時