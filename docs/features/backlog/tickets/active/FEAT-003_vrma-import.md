# FEAT-003 VRMAファイルインポート機能

**作成日**: 2025-01-06  
**更新日**: 2025-01-06  
**ステータス**: Planning  
**優先度**: P2  
**見積もり**: L (2-3週間)  
**担当者**: 未定  

## 概要

ユーザーが設定画面からVRMAファイル（VRMアニメーション）をインポートし、マスコットのアニメーションとして使用できるようにする機能。複数のアニメーションを管理でき、それぞれにカテゴリを設定可能。システムにはデフォルトのidleアニメーションを内蔵。

## ユーザーストーリー

```
As a ユーザー
I want to 自分の好きなVRMAアニメーションをマスコットに追加したい
So that マスコットの動きをカスタマイズして、より個性的な体験を楽しめる
```

## 詳細要件

### 機能要件

1. **アニメーション管理**
   - VRMAファイルの選択・インポート機能
   - インポートしたアニメーションの一覧表示
   - アニメーションの削除機能
   - デフォルトidleアニメーションの提供（削除不可）

2. **カテゴリ設定**
   - 各アニメーションにカテゴリを設定
   - カテゴリ例：idle, action, emotion, reaction, custom
   - 同一カテゴリに複数アニメーション登録可能

3. **プレビュー機能**
   - 選択したアニメーションのプレビュー再生
   - プレビュー中は他のアニメーションを一時停止

4. **トリガー設定**
   - idleカテゴリ：アイドル時にランダム再生
   - その他：将来的な拡張用（この実装では手動再生のみ）

### 非機能要件

- パフォーマンス: アニメーションファイルのロードが高速（3秒以内）
- ストレージ: インポートしたVRMAファイルの保存場所管理
- 互換性: 標準的なVRMA形式をサポート
- エラーハンドリング: 不正なファイルの検証とエラー表示

## 技術的考慮事項

### アーキテクチャへの影響

- 影響を受けるFeature: 
  - `features/vrm-control/` - アニメーション管理の拡張
  - `features/settings/` - 設定UIの追加
- 新規作成が必要なFeature: なし
- 依存関係: 
  - @pixiv/three-vrm のVRMALoader
  - electron-storeでのメタデータ保存

### 実装方針

FSDに基づく実装計画：

```
features/
├── vrm-control/
│   ├── api/
│   │   └── vrma-loader.ts         # VRMAファイルのロード
│   ├── model/
│   │   └── animation-store.ts      # アニメーション管理Store
│   └── lib/
│       └── animation-catalog.ts    # カテゴリ管理ロジック
└── settings/
    └── ui/
        └── AnimationSettings.tsx   # アニメーション設定UI
```

### データ構造

```typescript
interface AnimationEntry {
  id: string;
  name: string;
  filePath: string;
  category: AnimationCategory;
  isDefault: boolean;
  addedAt: string;
}

type AnimationCategory = 'idle' | 'action' | 'emotion' | 'reaction' | 'custom';
```

## 受け入れ条件

- [ ] VRMAファイルを選択してインポートできる
- [ ] インポートしたアニメーションが一覧表示される
- [ ] アニメーションにカテゴリを設定できる
- [ ] アニメーションをプレビュー再生できる
- [ ] アニメーションを削除できる（デフォルト以外）
- [ ] デフォルトidleアニメーションが提供される
- [ ] 不正なファイルに対するエラー表示
- [ ] 設定が永続化される
- [ ] ユニットテストが書かれている

## UI/UXデザイン

### 設定画面のアニメーションタブ

```
[アニメーション設定]

デフォルトアニメーション:
- 🔒 Idle (システムデフォルト) [▶️ プレビュー]

カスタムアニメーション:
- Walk_01 (idle) [▶️] [🗑️]
- Happy_Dance (emotion) [▶️] [🗑️]
- Wave_Hand (action) [▶️] [🗑️]

[+ アニメーションを追加]
```

### アニメーション追加ダイアログ

```
ファイル: [選択...] (.vrma)
名前: [Walk_01]
カテゴリ: [idle ▼]
[キャンセル] [追加]
```

## テスト計画

### ユニットテスト

- [ ] VRMALoaderのファイル読み込みテスト
- [ ] AnimationStoreの追加・削除・更新テスト
- [ ] カテゴリフィルタリングのテスト
- [ ] ファイルバリデーションのテスト

### 統合テスト

- [ ] 設定画面との連携テスト
- [ ] アニメーション再生システムとの統合テスト
- [ ] 永続化と復元のテスト
- [ ] E2Eテスト（ファイル選択から再生まで）

## リスクと軽減策

| リスク | 影響度 | 軽減策 |
|--------|--------|--------|
| 大きなVRMAファイルによるメモリ使用 | High | ファイルサイズ制限（50MB）を設定 |
| 互換性のないVRMAファイル | Medium | ロード前の形式検証、エラー時の詳細表示 |
| 多数のアニメーションによるUI混雑 | Low | ページネーションまたはスクロール可能リスト |

## 実装メモ

### 2025-01-06
- 初期仕様策定
- デフォルトidleアニメーションをアプリにバンドルする方針を決定
- 将来的には、カテゴリごとの自動再生トリガーを追加予定

## 関連リンク

- 関連Issue: #
- 関連PR: #
- 設計ドキュメント: 
- 参考資料:
  - [VRM Animation仕様](https://github.com/vrm-c/vrm-specification/blob/master/specification/VRMC_vrm_animation-1.0/README.md)
  - 既存のidle.vrma検出ロジック（要リファクタリング）