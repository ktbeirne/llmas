/**
 * App.tsx - Reactè¨­å®šç”»é¢ã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 * 
 * Phase 3.1.5: åŸºæœ¬çš„ãªReactã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆ
 * ElectronAPIã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªã¨Hot Reloadå‹•ä½œç¢ºèªç”¨
 */

import { useState, useEffect } from 'react';

import './App.css';
import { ReactElectronAPITester } from './reactApiTest';
import { HMRTester } from './hmrTest';

interface AppProps {
  className?: string;
}

/**
 * Reactç‰ˆè¨­å®šç”»é¢ã®ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
 */
const App: React.FC<AppProps> = ({ className = '' }) => {
  // åŸºæœ¬çŠ¶æ…‹ç®¡ç†
  const [isLoading, setIsLoading] = useState(true);
  const [electronAPIStatus, setElectronAPIStatus] = useState<'checking' | 'available' | 'unavailable'>('checking');
  const [appInfo, setAppInfo] = useState<{
    version?: string;
    platform?: string;
    arch?: string;
  }>({});
  const [testResults, setTestResults] = useState<any[]>([]);
  const [isTestRunning, setIsTestRunning] = useState(false);
  const [hmrResults, setHmrResults] = useState<any[]>([]);
  const [isHmrTestRunning, setIsHmrTestRunning] = useState(false);

  // ElectronAPIå‹•ä½œç¢ºèª
  useEffect(() => {
    const checkElectronAPI = async () => {
      try {
        // ElectronAPIã®å­˜åœ¨ç¢ºèª
        if (!window.electronAPI) {
          setElectronAPIStatus('unavailable');
          setIsLoading(false);
          return;
        }

        console.log('[React App] ElectronAPI detected, checking methods...');
        
        // åŸºæœ¬çš„ãªAPIå‹•ä½œç¢ºèª
        const apiMethods = [
          'getWindowSettings',
          'getChatSettings', 
          'getTheme',
          'getExpressionSettings'
        ];

        const availableMethods = apiMethods.filter(method => 
          typeof window.electronAPI[method] === 'function'
        );

        console.log(`[React App] Available API methods: ${availableMethods.length}/${apiMethods.length}`);
        console.log('[React App] Available methods:', availableMethods);

        // ã‚¢ãƒ—ãƒªæƒ…å ±å–å¾—è©¦è¡Œ
        if (typeof window.electronAPI.getAppInfo === 'function') {
          try {
            const info = await window.electronAPI.getAppInfo();
            setAppInfo(info || {});
            console.log('[React App] App info retrieved:', info);
          } catch (error) {
            console.warn('[React App] Failed to get app info:', error);
          }
        }

        setElectronAPIStatus('available');
        setIsLoading(false);
        
        console.log('[React App] ElectronAPI check completed successfully');
      } catch (error) {
        console.error('[React App] ElectronAPI check failed:', error);
        setElectronAPIStatus('unavailable');
        setIsLoading(false);
      }
    };

    checkElectronAPI();
  }, []);

  // Hot Reloadæ¤œè¨¼ç”¨ã®æ™‚åˆ»è¡¨ç¤º
  const [currentTime, setCurrentTime] = useState(new Date().toLocaleTimeString());
  
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date().toLocaleTimeString());
    }, 1000);

    return () => clearInterval(timer);
  }, []);

  // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  if (isLoading) {
    return (
      <div className={`react-app loading ${className}`}>
        <div className="loading-container">
          <div className="loading-spinner"></div>
          <p>Reactè¨­å®šç”»é¢ã‚’åˆæœŸåŒ–ä¸­...</p>
        </div>
      </div>
    );
  }

  return (
    <div className={`react-app ${className}`} data-testid="react-app">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <header className="app-header">
        <h1>ğŸš€ Reactè¨­å®šç”»é¢ (Phase 3) - HMR ãƒ†ã‚¹ãƒˆ</h1>
        <p className="subtitle">LLM Desktop Mascot - Reactç§»è¡Œç‰ˆ (Hot Reloadæ¤œè¨¼ä¸­)</p>
      </header>

      {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <main className="app-main">
        {/* ElectronAPIçŠ¶æ…‹è¡¨ç¤º */}
        <section className="api-status-section">
          <h2>ğŸ“¡ ElectronAPIçŠ¶æ…‹</h2>
          <div className={`api-status ${electronAPIStatus}`}>
            <div className="status-indicator">
              {electronAPIStatus === 'available' && 'âœ… æ­£å¸¸'}
              {electronAPIStatus === 'unavailable' && 'âŒ åˆ©ç”¨ä¸å¯'}
              {electronAPIStatus === 'checking' && 'ğŸ”„ ç¢ºèªä¸­'}
            </div>
            <div className="status-details">
              <p><strong>çŠ¶æ…‹:</strong> {
                electronAPIStatus === 'available' ? 'ElectronAPIåˆ©ç”¨å¯èƒ½' :
                electronAPIStatus === 'unavailable' ? 'ElectronAPIåˆ©ç”¨ä¸å¯' :
                'ElectronAPIç¢ºèªä¸­'
              }</p>
              {appInfo.version && (
                <>
                  <p><strong>Version:</strong> {appInfo.version}</p>
                  <p><strong>Platform:</strong> {appInfo.platform}</p>
                  <p><strong>Architecture:</strong> {appInfo.arch}</p>
                </>
              )}
            </div>
          </div>
        </section>

        {/* Hot Reloadç¢ºèªã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
        <section className="hot-reload-section">
          <h2>ğŸ”¥ Hot ReloadçŠ¶æ…‹</h2>
          <div className="hot-reload-status">
            <p><strong>ç¾åœ¨æ™‚åˆ»:</strong> {currentTime}</p>
            <p className="hot-reload-note">
              â€» ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ä¿å­˜ã™ã‚‹ã¨ã€Hot ReloadãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™
            </p>
          </div>
        </section>

        {/* æ¬¡æœŸå®Ÿè£…äºˆå‘Š */}
        <section className="roadmap-section">
          <h2>ğŸ—ºï¸ Phase 3å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—</h2>
          <div className="roadmap-grid">
            <div className="roadmap-item completed">
              <h3>âœ… Phase 3.1: ReactåŸºç›¤æ§‹ç¯‰ - å®Œäº†æ¸ˆã¿</h3>
              <ul>
                <li>âœ… React 19ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</li>
                <li>âœ… TypeScript JSXè¨­å®š</li>
                <li>âœ… åŸºæœ¬App.tsxä½œæˆ</li>
                <li>âœ… ElectronAPIçµ±åˆç¢ºèª</li>
                <li>âœ… HMRå‹•ä½œç¢ºèª (Phase 3.1.7-3.1.8)</li>
              </ul>
            </div>
            <div className="roadmap-item pending">
              <h3>ğŸ”„ Phase 3.2: çŠ¶æ…‹ç®¡ç†ãƒ»HookåŸºç›¤</h3>
              <ul>
                <li>Zustand Storeå®Ÿè£…</li>
                <li>Custom Hooksä½œæˆ</li>
                <li>ReactUIAdapterå®Ÿè£…</li>
                <li>å‹å®‰å…¨IPC Bridge</li>
              </ul>
            </div>
            <div className="roadmap-item pending">
              <h3>â³ Phase 3.3: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç§»è¡Œ</h3>
              <ul>
                <li>WindowSettingsComponent ReactåŒ–</li>
                <li>ThemeSettingsComponent ReactåŒ–</li>
                <li>ChatSettingsComponent ReactåŒ–</li>
                <li>ExpressionSettingsComponent ReactåŒ–</li>
              </ul>
            </div>
            <div className="roadmap-item pending">
              <h3>â³ Phase 3.4: çµ±åˆãƒ»æœ€é©åŒ–</h3>
              <ul>
                <li>å…¨ä½“çµ±åˆãƒ»ãƒ†ã‚¹ãƒˆ</li>
                <li>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–</li>
                <li>ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ”¹å–„</li>
                <li>æœ¬ç•ªç’°å¢ƒæº–å‚™</li>
              </ul>
            </div>
          </div>
        </section>

        {/* ElectronAPI ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
        <section className="api-test-section">
          <h2>ğŸ§ª ElectronAPIçµ±åˆãƒ†ã‚¹ãƒˆ (Phase 3.1.7)</h2>
          <div className="api-test-controls">
            <button 
              onClick={async () => {
                setIsTestRunning(true);
                try {
                  const tester = new ReactElectronAPITester();
                  const results = await tester.runAllTests();
                  setTestResults(results);
                } catch (error) {
                  console.error('API test failed:', error);
                } finally {
                  setIsTestRunning(false);
                }
              }}
              disabled={isTestRunning || electronAPIStatus !== 'available'}
              className={electronAPIStatus === 'available' ? 'primary' : 'secondary'}
            >
              {isTestRunning ? 'ğŸ”„ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...' : 'ğŸš€ ElectronAPI ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'}
            </button>
            {testResults.length > 0 && (
              <div className="test-results">
                <h3>ãƒ†ã‚¹ãƒˆçµæœ:</h3>
                <div className="test-summary">
                  <span className="success-count">âœ… æˆåŠŸ: {testResults.filter(r => r.success).length}</span>
                  <span className="fail-count">âŒ å¤±æ•—: {testResults.filter(r => !r.success).length}</span>
                </div>
                <details>
                  <summary>è©³ç´°çµæœ</summary>
                  <div className="test-details">
                    {testResults.map((result, index) => (
                      <div key={index} className={`test-item ${result.success ? 'success' : 'fail'}`}>
                        <h4>{result.success ? 'âœ…' : 'âŒ'} {result.name}</h4>
                        {result.error && <p className="error-msg">ã‚¨ãƒ©ãƒ¼: {result.error}</p>}
                        {result.data && (
                          <pre className="test-data">{JSON.stringify(result.data, null, 2)}</pre>
                        )}
                        <p className="duration">å®Ÿè¡Œæ™‚é–“: {result.duration?.toFixed(2)}ms</p>
                      </div>
                    ))}
                  </div>
                </details>
              </div>
            )}
          </div>
        </section>

        {/* HMRãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
        <section className="hmr-test-section">
          <h2>ğŸ”¥ Hot Module Replacement ãƒ†ã‚¹ãƒˆ (Phase 3.1.8)</h2>
          <div className="hmr-test-controls">
            <button 
              onClick={async () => {
                setIsHmrTestRunning(true);
                try {
                  const tester = new HMRTester();
                  const results = await tester.runHMRTests();
                  setHmrResults(results);
                  
                  // HMRç›£è¦–é–‹å§‹
                  tester.startHMRMonitoring();
                } catch (error) {
                  console.error('HMR test failed:', error);
                } finally {
                  setIsHmrTestRunning(false);
                }
              }}
              disabled={isHmrTestRunning}
              className="primary"
            >
              {isHmrTestRunning ? 'ğŸ”„ HMRãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...' : 'ğŸš€ HMRæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ'}
            </button>
            
            {hmrResults.length > 0 && (
              <div className="test-results">
                <h3>HMRãƒ†ã‚¹ãƒˆçµæœ:</h3>
                <div className="test-summary">
                  <span className="success-count">âœ… å‹•ä½œä¸­: {hmrResults.filter(r => r.status === 'working').length}</span>
                  <span className="fail-count">âŒ éå‹•ä½œ: {hmrResults.filter(r => r.status === 'not-working').length}</span>
                  <span className="unknown-count">â“ ä¸æ˜: {hmrResults.filter(r => r.status === 'unknown').length}</span>
                </div>
                <details>
                  <summary>HMRè©³ç´°çµæœ</summary>
                  <div className="test-details">
                    {hmrResults.map((result, index) => (
                      <div key={index} className={`test-item ${result.status}`}>
                        <h4>
                          {result.status === 'working' && 'âœ…'}
                          {result.status === 'not-working' && 'âŒ'}
                          {result.status === 'unknown' && 'â“'}
                          {' '}{result.feature}
                        </h4>
                        <p className="test-details-text">{result.details}</p>
                        <p className="timestamp">æ™‚åˆ»: {new Date(result.timestamp).toLocaleString()}</p>
                      </div>
                    ))}
                  </div>
                </details>
              </div>
            )}
            
            <div className="hmr-live-test">
              <h3>ğŸ”¥ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ HMRãƒ†ã‚¹ãƒˆ</h3>
              <p>
                <strong>å‹•ä½œç¢ºèª:</strong> ã“ã®ãƒ•ã‚¡ã‚¤ãƒ« (App.tsx) ã‚’ç·¨é›†ã—ã¦ä¿å­˜ã™ã‚‹ã¨ã€
                ãƒšãƒ¼ã‚¸ã®å†èª­ã¿è¾¼ã¿ãªã—ã§å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
              </p>
              <div className="hmr-indicator">
                <span className="hmr-status-dot"></span>
                <span>ç¾åœ¨æ™‚åˆ»: {currentTime}</span>
                {import.meta.hot && <span className="hmr-active"> (HMRæœ‰åŠ¹)</span>}
              </div>
            </div>
          </div>
        </section>

        {/* ãƒ‡ãƒãƒƒã‚°æƒ…å ± */}
        <section className="debug-section">
          <h2>ğŸ› ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
          <details>
            <summary>æŠ€è¡“è©³ç´°ã‚’è¡¨ç¤º</summary>
            <div className="debug-info">
              <p><strong>React Version:</strong> {React.version}</p>
              <p><strong>Build Time:</strong> {new Date().toISOString()}</p>
              <p><strong>Environment:</strong> {process.env.NODE_ENV || 'development'}</p>
              <p><strong>User Agent:</strong> {navigator.userAgent}</p>
              <pre className="electron-api-dump">
                <strong>Available ElectronAPI Methods:</strong>
                {electronAPIStatus === 'available' && window.electronAPI ? 
                  JSON.stringify(Object.keys(window.electronAPI), null, 2) :
                  'ElectronAPI not available'
                }
              </pre>
            </div>
          </details>
        </section>
      </main>

      {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
      <footer className="app-footer">
        <p>Phase 3: Reactç§»è¡Œå®Ÿè£… - Think Harder Approach</p>
        <p className="build-info">
          Generated with Claude Code - {new Date().toLocaleDateString()}
        </p>
      </footer>
    </div>
  );
};

export default App;