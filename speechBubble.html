<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Speech Bubble</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            /* chat.css と合わせても良いですね */
            background-color: transparent;
            /* ウィンドウ背景は透明 */
            overflow: hidden;
            /* はみ出しは表示しない */
            display: flex;
            /* 中身を中央寄せにするため (任意) */
            justify-content: center;
            align-items: center;
            height: 100vh;
            /* ウィンドウの高さ一杯に */
        }

        #bubble-content {
            background-color: rgba(255, 255, 255, 0.9);
            /* 吹き出し本体の背景色 */
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            min-width: 140px;
            /* 吹き出しの最大幅 */
            max-height: 150px;
            /* 吹き出しの最大高さ */
            overflow-y: auto;
            /* 内容が超えたらスクロール */
            white-space: pre-line;
            /* 改行を反映 */
            color: #333;
            font-size: 14px;
            /* しっぽは後でCSSの疑似要素で追加するか、画像にします */
        }
    </style>
</head>

<body>
    <div id="bubble-content">
    </div>
    <script>
        const bubbleContent = document.getElementById('bubble-content');
        let hideTimeout = null;

        const MIN_DISPLAY_TIME_MS = 5000;    // 最低表示時間 (ミリ秒)
        const MAX_DISPLAY_TIME_MS = 30000;   // 最大表示時間 (ミリ秒)
        const CHARS_PER_SECOND_READING_SPEED = 6; // 1秒あたりに読める文字数

        if (window.electronAPI && window.electronAPI.onSetSpeechBubbleText) {
            window.electronAPI.onSetSpeechBubbleText((text) => {
                if (bubbleContent) {
                    bubbleContent.textContent = text;

                    if (hideTimeout) {
                        clearTimeout(hideTimeout);
                    }

                    if (text && text.trim() !== "") {
                        // ★ 文字数から表示時間を計算
                        let calculatedDisplayTimeMs = (text.length / CHARS_PER_SECOND_READING_SPEED) * 1000;

                        // 最低表示時間を適用
                        calculatedDisplayTimeMs = Math.max(MIN_DISPLAY_TIME_MS, calculatedDisplayTimeMs);
                        // 最大表示時間を適用
                        calculatedDisplayTimeMs = Math.min(MAX_DISPLAY_TIME_MS, calculatedDisplayTimeMs);

                        console.log(`Bubble text length: ${text.length}, Calculated display time: ${calculatedDisplayTimeMs / 1000}s`);

                        hideTimeout = setTimeout(() => {
                            bubbleContent.textContent = '';
                            // ★ メインプロセスに非表示を通知する場合は、ここでAPIを呼ぶ
                            if (window.electronAPI && window.electronAPI.hideSpeechBubble) {
                                window.electronAPI.hideSpeechBubble();
                            }
                        }, calculatedDisplayTimeMs); // ★ 計算した表示時間を使う
                    } else {
                        // テキストが空なら即座に内容をクリア (または非表示)
                        bubbleContent.textContent = '';
                        // ★ メインプロセスに非表示を通知する場合
                        // if (window.electronAPI && window.electronAPI.hideSpeechBubble) {
                        //     window.electronAPI.hideSpeechBubble();
                        // }
                    }
                }
            });
        }
    </script>
</body>

</html>