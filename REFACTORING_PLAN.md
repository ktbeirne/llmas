# リファクタリング計画書

## 概要
このドキュメントは、LLMASコードベースの包括的な分析に基づいて作成されたリファクタリング計画です。現在の技術的負債を解消し、保守性、テスタビリティ、パフォーマンスを向上させることを目的としています。

## 現状分析サマリー

### 主要な問題点
1. **アーキテクチャの問題**
   - main.ts が1065行の巨大ファイルで、責任が過度に集中
   - 関心事の分離が不十分（ウィンドウ管理、IPC、ビジネスロジックが混在）
   - ハードコードされた設定値
   - 依存性注入の欠如

2. **コード品質の問題**
   - ESLintで79個の警告・エラー検出
   - 型安全性の欠如（any型の多用）
   - マジックナンバーの散在
   - エラーハンドリングの不統一

3. **テストカバレッジの不足**
   - ユニットテストが2ファイルのみ
   - メインプロセスのテスト欠如
   - E2Eテストの限定的なカバレッジ

4. **セキュリティとパフォーマンス**
   - APIキーの検証不足
   - IPCメッセージの検証欠如
   - メモリリーク（イベントリスナーの不適切な管理）
   - タイトルバー監視の非効率な実装（60fps常時実行）

5. **依存関係の問題**
   - 古いTypeScriptバージョン（4.5.4）
   - 非推奨パッケージの使用
   - セキュリティ脆弱性の存在

## リファクタリング実施計画

### フェーズ1: 基盤整備（1-2週間）

#### 1.1 開発環境の更新
- [ ] TypeScriptを5.xへアップグレード
- [ ] ESLint設定の更新（最新のflat config形式へ）
- [ ] 依存関係の更新とセキュリティ監査
- [ ] Vitestの設定改善

#### 1.2 型安全性の向上
- [ ] すべての`any`型を適切な型に置換
- [ ] IPC通信用の型定義ファイル作成
- [ ] strictモードの有効化

#### 1.3 テスト基盤の構築
- [ ] Electronモックの設定
- [ ] テストヘルパーとユーティリティの作成
- [ ] CIでのテスト自動実行設定

### フェーズ2: アーキテクチャ改善（2-3週間）

#### 2.1 メインプロセスのリファクタリング
```typescript
// 新しいディレクトリ構造
src/
├── main/
│   ├── index.ts              // エントリーポイント
│   ├── windows/              // ウィンドウ管理
│   │   ├── WindowManager.ts
│   │   ├── MainWindow.ts
│   │   ├── ChatWindow.ts
│   │   └── SettingsWindow.ts
│   ├── ipc/                  // IPC通信
│   │   ├── handlers/
│   │   ├── validators/
│   │   └── types.ts
│   ├── services/             // ビジネスロジック
│   │   ├── GeminiService.ts
│   │   ├── VRMService.ts
│   │   └── ThemeService.ts
│   └── stores/               // 状態管理
│       ├── SettingsStore.ts
│       └── ChatHistoryStore.ts
```

#### 2.2 依存性注入の実装
- [ ] DIコンテナの導入（例：InversifyJS）
- [ ] サービスクラスのインターフェース定義
- [ ] シングルトンパターンの除去

#### 2.3 IPC通信の抽象化
- [ ] 型安全なIPCラッパーの作成
- [ ] メッセージバリデーションの実装
- [ ] エラーハンドリングの統一

### フェーズ3: コンポーネント改善とReactフレームワーク導入（3-4週間）

#### 3.1 レンダラープロセスの整理
- [ ] コンポーネント単位でのファイル分割
- [ ] 共通UIコンポーネントの抽出
- [ ] 状態管理の改善（Context APIまたは軽量な状態管理ライブラリ）

#### 3.2 VRMコントローラーの改善
- [ ] アニメーション管理の抽象化
- [ ] リソース管理の改善
- [ ] パフォーマンス最適化（フレームレート制御）

#### 3.3 タイトルバー処理の最適化
- [ ] 監視頻度の動的調整
- [ ] requestAnimationFrameの適切な使用
- [ ] メモリリークの修正

#### 3.4 React フレームワーク導入評価

##### 現在の実装分析
現在のUIは完全にバニラJavaScript/TypeScriptで実装されており、以下の特徴があります：
- **フレームワーク不使用**: 直接的なDOM操作による実装
- **マルチウィンドウ**: 各ウィンドウが独立したレンダラー
- **手動の状態管理**: IPCを介したウィンドウ間通信
- **CSSベースのテーマ**: CSS変数による実装

##### React + Electron + Three.js統合パターン
- **React Three Fiber (R3F)**: Three.jsのReactラッパー
  - 宣言的な3Dシーン構築
  - Reactのライフサイクルと統合
  - コンポーネントベースの3Dオブジェクト管理
- **Electron + React**: 成熟した統合
  - electron-viteやelectron-reactなどのボイラープレート
  - HMR（ホットモジュールリプレースメント）対応
  - TypeScriptとの良好な統合
- **状態管理**: Redux/Zustandでグローバル状態管理、React ContextでIPC通信の抽象化

##### React導入のメリット・デメリット

**メリット 👍**
- **コンポーネントベース開発**: UIの再利用性向上、保守性の改善、チーム開発の効率化
- **状態管理の改善**: 単方向データフロー、予測可能な状態変更、デバッグの容易化
- **開発体験の向上**: HMRによる高速開発、豊富なデバッグツール、大規模なエコシステム
- **テストの改善**: React Testing Library、コンポーネント単位のテスト、モックの容易化

**デメリット 👎**
- **学習コスト**: React特有の概念の習得、既存コードの大規模な書き換え、Three.jsとの統合の複雑さ
- **バンドルサイズの増加**: React + ReactDOM ≈ 45KB (gzip)、追加ライブラリの必要性、起動時間への影響
- **移行の複雑さ**: 段階的移行が困難、マルチウィンドウ対応、既存機能の保証
- **パフォーマンスリスク**: 仮想DOMのオーバーヘッド、Three.jsとの二重レンダリング、メモリ使用量の増加

#### 3.5 段階的React移行計画

##### 推奨アプローチ: 部分的導入
完全移行ではなく、以下の部分的な導入を推奨：

```typescript
// 新しいディレクトリ構造（React統合版）
src/
├── components/       // React コンポーネント
│   ├── common/       // 共通コンポーネント
│   ├── chat/         // チャット画面用
│   ├── settings/     // 設定画面用
│   └── three/        // Three.js統合用（将来的）
├── hooks/           // カスタムフック
├── contexts/        // React Context
├── legacy/          // 既存コード（一時的）
└── main/           // メインプロセス（既存）
```

##### 段階的移行フェーズ

**サブフェーズ3.5.1: 基盤準備（1週間）**
- [ ] React + TypeScript + Vite環境の構築
- [ ] ESLint + Prettierの設定更新
- [ ] Electronとの統合テスト
- [ ] ホットリロード対応

**サブフェーズ3.5.2: 設定画面の移行（2週間）**
- [ ] 最も独立性の高い設定画面をReactに移行
- [ ] 共通コンポーネントライブラリの構築
- [ ] テーマシステムのReact対応
- [ ] フォーム管理とバリデーション

**サブフェーズ3.5.3: チャット画面の移行（2週間）**
- [ ] メッセージコンポーネントの作成
- [ ] 状態管理の実装（Zustand推奨）
- [ ] リアルタイム更新の最適化
- [ ] アニメーション対応

**サブフェーズ3.5.4: メインウィンドウの統合検討（3週間）**
- [ ] React Three Fiberの導入評価
- [ ] VRMコントローラーのReact統合
- [ ] パフォーマンステスト
- [ ] 最終判断（現状維持も選択肢）

##### 代替案の検討

React以外の軽量な選択肢：
- **Lit**: Web Components ベース、軽量（16KB）
- **Alpine.js**: 宣言的、最小限の学習コスト
- **Preact**: React互換、軽量版（3KB）

##### 実装優先順位と推奨事項

**✅ 推奨するケース**
- チーム開発を予定している
- 長期的なメンテナンスを重視
- UIの複雑性が今後増加する見込み
- 新規開発者の参加が予想される

**❌ 推奨しないケース**
- 現在のコードベースに満足している
- パフォーマンスが最優先事項
- 短期的なプロジェクト
- リソースが限られている

**最終推奨事項**
設定画面とチャット画面にのみReactを適用し、Three.jsを使用するメインウィンドウは現在の実装を維持する **ハイブリッドアプローチ** を推奨します。これにより、リスクを最小限に抑えながらReactのメリットを享受できます。

### フェーズ4: テスト実装（2-3週間）

#### 4.1 ユニットテスト
- [ ] すべてのサービスクラスのテスト
- [ ] ストアクラスのテスト
- [ ] ユーティリティ関数のテスト
- [ ] 目標カバレッジ: 80%以上

#### 4.2 統合テスト
- [ ] IPC通信のテスト
- [ ] ウィンドウ間連携のテスト
- [ ] エラーリカバリーのテスト

#### 4.3 E2Eテスト
- [ ] 主要ユーザーフローのテスト
- [ ] 設定変更フローのテスト
- [ ] チャット機能のテスト

### フェーズ5: 最適化と仕上げ（1週間）

#### 5.1 パフォーマンス最適化
- [ ] バンドルサイズの削減
- [ ] 起動時間の短縮
- [ ] メモリ使用量の最適化

#### 5.2 ドキュメント整備
- [ ] アーキテクチャドキュメントの作成
- [ ] API仕様書の作成
- [ ] 開発者ガイドの更新

#### 5.3 CI/CD改善
- [ ] 自動テストの強化
- [ ] コード品質チェックの自動化
- [ ] リリースプロセスの改善

## 優先度別タスクリスト

### 優先度: 高（即座に対応すべき）
1. TypeScript strictモードの有効化と型安全性の向上
2. main.tsの分割とモジュール化
3. セキュリティ脆弱性の修正
4. メモリリークの修正

### 優先度: 中（計画的に対応）
1. テストカバレッジの向上
2. IPC通信の抽象化
3. タイトルバー処理の最適化
4. 依存関係の更新
5. **React導入の評価と準備**（設定画面とチャット画面のみ）

### 優先度: 低（時間があれば対応）
1. UIコンポーネントの共通化
2. ドキュメントの充実
3. パフォーマンスの微調整
4. **React Three Fiberによるメインウィンドウ統合**（十分な評価とテスト後）

## 実装上の注意事項

1. **段階的なリファクタリング**
   - 一度にすべてを変更せず、小さな変更を積み重ねる
   - 各変更後にテストを実行し、動作を確認

2. **後方互換性の維持**
   - 既存の機能を損なわないよう注意
   - 設定ファイルの互換性を保つ

3. **コードレビューの徹底**
   - すべての変更をPRで管理
   - 最低1人のレビューを必須とする

4. **継続的な改善**
   - リファクタリング完了後も定期的なコードレビュー
   - 新機能追加時の設計レビュー

5. **React導入時の特別な注意事項**
   - **パフォーマンス監視**: Reactアプリケーションのバンドルサイズと起動時間を定期的に測定
   - **Electron統合**: IPCとReactコンポーネント間の適切なデータフローを維持
   - **ハイブリッド運用**: React化した部分と既存コードとの整合性を保つ
   - **段階的移行**: 各フェーズで必ず機能テストを実施し、回帰がないことを確認
   - **Three.js統合**: メインウィンドウでReact Three Fiberを使用する場合は、パフォーマンスへの影響を徹底的に評価
   - **依存関係管理**: React関連パッケージの更新時は、Electronとの互換性を事前に確認

## 期待される成果

1. **開発効率の向上**
   - コードの可読性と保守性の改善
   - 新機能追加の容易化
   - バグ修正時間の短縮

2. **品質の向上**
   - バグの早期発見
   - 回帰テストによる品質保証
   - 型安全性による実行時エラーの削減

3. **パフォーマンスの改善**
   - 起動時間の短縮
   - メモリ使用量の削減
   - レスポンシブなUI

4. **セキュリティの強化**
   - 入力検証の徹底
   - APIキーの適切な管理
   - 依存関係の脆弱性解消

5. **React導入による追加の成果**（部分的導入の場合）
   - **設定画面の改善**: より直感的で保守性の高い設定UI
   - **チャット画面の強化**: リアルタイム更新の最適化とアニメーション対応
   - **開発者体験**: HMRによる高速な開発サイクル
   - **テスタビリティ**: コンポーネント単位でのテスト可能性
   - **将来への準備**: 新機能追加時のコンポーネント再利用

## まとめ

このリファクタリング計画は、現在のコードベースの問題点を体系的に解決し、将来の拡張性と保守性を確保することを目的としています。段階的なアプローチにより、リスクを最小限に抑えながら着実に改善を進めることができます。

**React フレームワーク導入について**、詳細な調査と評価を経て、**部分的導入（ハイブリッドアプローチ）** を推奨します。設定画面とチャット画面にのみReactを適用し、Three.jsメインウィンドウは現状を維持することで、リスクを最小化しながらモダンな開発手法の恩恵を受けることができます。

計画の実施には約10-12週間を見込んでいますが（React導入を含む場合）、優先度の高い項目から順次対応することで、早期に効果を実感できるはずです。React導入は必須ではなく、プロジェクトの状況と要件に応じて柔軟に判断することが重要です。

チーム全体でこの計画を共有し、継続的な改善文化を醸成することが成功の鍵となります。特にReact導入を検討する場合は、十分な評価期間と段階的な移行を心がけることで、安全かつ効果的な近代化を実現できます。